name: Playwright Tests

on:
  push:
    branches: [main, develop]

  merge_group:
    branches: [main, develop]

  # re-register cron
  workflow_dispatch:

  # ğŸ‘‰ Cron cháº¡y má»—i ngÃ y
  schedule:
    - cron: "0 1 * * *"

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # ğŸ‘‰ Cron luÃ´n dÃ¹ng staging (trÃ¡nh bá»‹ hiá»ƒu nháº§m lÃ  main)
    # âœ… FIX: dÃ¹ng github.ref thay vÃ¬ github.ref_name
    # âœ… FIX: viáº¿t 1 dÃ²ng Ä‘á»ƒ trÃ¡nh lá»—i YAML
    # âœ… FIX (NEW): dÃ¹ng startsWith Ä‘á»ƒ support merge_group (merge queue táº¡o ref Ä‘áº·c biá»‡t)
    environment: ${{ github.event_name == 'schedule' && 'staging' || startsWith(github.ref, 'refs/heads/main') && 'production' || startsWith(github.ref, 'refs/heads/develop') && 'staging' }}

    # ğŸ‘‰ Chia test thÃ nh 4 shard Ä‘á»ƒ cháº¡y song song
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    env:
      # âš ï¸ Biáº¿n nÃ y láº¥y tá»« GitHub Environment (staging / production)
      # ğŸ‘‰ Chá»‰ Ä‘Ãºng khi environment phÃ­a trÃªn resolve Ä‘Ãºng
      ENV: ${{ vars.ENV }}

      # âœ… NEW: Base URL cho Playwright (production/staging tÃ¹y environment)
      BASE_URL: ${{ vars.BASE_URL }}

      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      # ğŸ‘‰ Cron checkout develop
      # âš ï¸ LÆ°u Ã½: github.ref_name cá»§a cron váº«n lÃ  main
      # â†’ nÃªn pháº£i Ã©p checkout develop Ä‘á»ƒ test Ä‘Ãºng staging
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # ğŸ‘‰ Cháº¡y test theo shard + táº¡o blob report Ä‘á»ƒ merge sau
      - name: Run Playwright tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }}/4 \
            --reporter=blob \
            --retries=1

      # ğŸ‘‰ Upload blob report táº¡m thá»i (dÃ¹ng Ä‘á»ƒ merge)
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1


  # ğŸ‘‰ Merge táº¥t cáº£ shard thÃ nh 1 HTML report duy nháº¥t
  merge-report:
    if: always()
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      # ğŸ‘‰ Download toÃ n bá»™ blob report tá»« cÃ¡c shard
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports

      # ğŸ‘‰ FIX: Flatten táº¥t cáº£ file blob report vÃ o 1 folder chung
      # âš ï¸ Playwright merge-reports yÃªu cáº§u táº¥t cáº£ blob á»Ÿ cÃ¹ng 1 folder
      - name: Prepare blob reports
        run: |
          mkdir merged-blobs
          find all-blob-reports -type f -exec cp {} merged-blobs/ \;

      # ğŸ‘‰ Merge thÃ nh HTML duy nháº¥t
      - name: Merge reports thÃ nh HTML duy nháº¥t
        run: |
          npx playwright merge-reports \
          --reporter html,json \
          ./merged-blobs

      # âœ… NEW (Báº®T BUá»˜C): Upload report Ä‘Ã£ merge Ä‘á»ƒ job deploy dÃ¹ng
      # âš ï¸ Náº¿u khÃ´ng cÃ³ bÆ°á»›c nÃ y thÃ¬ deploy-report sáº½ FAIL vÃ¬ khÃ´ng tÃ¬m tháº¥y artifact
      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7


  # ğŸ‘‰ Deploy report lÃªn GitHub Pages (chá»‰ main)
  deploy-report:
    needs: merge-report

    # âœ… FIX (NEW): khÃ´ng deploy khi lÃ  cron
    # ğŸ‘‰ Cron chá»‰ dÃ¹ng Ä‘á»ƒ test staging
    if: github.ref == 'refs/heads/main' && github.event_name != 'schedule'

    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download final report
        uses: actions/download-artifact@v4
        with:
          # âš ï¸ Pháº£i trÃ¹ng Ä‘Ãºng tÃªn artifact Ä‘Ã£ upload á»Ÿ job merge-report
          name: playwright-report
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4


  notify-slack:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true
    environment: slack

    steps:
    - name: Send Slack notification
      run: |
        RESULT="${{ needs.merge-report.result }}"

        if [ "$RESULT" = "success" ]; then
          STATUS="PASSED"
          COLOR="#36a64f"
          ICON="âœ…"
        else
          STATUS="FAILED"
          COLOR="#ff0000"
          ICON="âŒ"
        fi

        # âš ï¸ FIX nhá»: cron checkout develop nhÆ°ng github.ref_name váº«n lÃ  main
        BRANCH="${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}"

        ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        WEBHOOK="${{ secrets.SLACK_WEBHOOK_URL }}"

        curl -X POST \
          -H "Content-type: application/json" \
          --data "{
            \"attachments\": [
              {
                \"color\": \"$COLOR\",
                \"title\": \"$ICON Playwright CI $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"$BRANCH\", \"short\": true},
                  {\"title\": \"Actions\", \"value\": \"$ACTION_URL\", \"short\": false},
                  {\"title\": \"Report\", \"value\": \"$REPORT_URL\", \"short\": false}
                ]
              }
            ]
          }" \
          "$WEBHOOK"


  notify-telegram:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true

    steps:
      - name: Send Telegram notification
        run: |
          RESULT="${{ needs.merge-report.result }}"

          if [ "$RESULT" = "success" ]; then
            STATUS="PASSED"
            ICON="âœ…"
          else
            STATUS="FAILED"
            ICON="âŒ"
          fi

          # âš ï¸ FIX nhá» giá»‘ng Slack
          BRANCH="${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}"

          ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          MESSAGE=$(cat <<EOF
          ğŸ­ Playwright CI $STATUS $ICON

          Repository: ${{ github.repository }}
          Branch: $BRANCH

          ğŸ”— Actions: $ACTION_URL
          ğŸ“ˆ Report: $REPORT_URL
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode text="$MESSAGE"
