name: Playwright Tests

on:
  push:
    branches: [main, develop]

  merge_group:
    branches: [main, develop]

  # re-register cron
  workflow_dispatch:

  # ğŸ‘‰ Cron cháº¡y má»—i ngÃ y
  schedule:
    - cron: "*/5 * * * *" # run má»—i 5p

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # ğŸ‘‰ Cron luÃ´n dÃ¹ng staging (trÃ¡nh bá»‹ hiá»ƒu nháº§m lÃ  main)
    # âœ… FIX: dÃ¹ng github.ref thay vÃ¬ github.ref_name
    # âœ… FIX: viáº¿t 1 dÃ²ng Ä‘á»ƒ trÃ¡nh lá»—i YAML
    environment: ${{ github.event_name == 'schedule' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/develop' && 'staging' }}

    # ğŸ‘‰ Chia test thÃ nh 3 shard Ä‘á»ƒ cháº¡y song song
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]

    env:
      ENV: ${{ vars.ENV }}
      BASE_URL: ${{ vars.BASE_URL }} # âœ… NEW: Base URL cho Playwright (production/staging tÃ¹y environment)
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      # ğŸ‘‰ Cron checkout develop
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # ğŸ‘‰ Cháº¡y test theo shard + táº¡o blob report Ä‘á»ƒ merge sau
      - name: Run Playwright tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }}/3 \
            --reporter=blob \
            --retries=1

      # ğŸ‘‰ Upload blob report táº¡m thá»i (dÃ¹ng Ä‘á»ƒ merge)
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1

  # ğŸ‘‰ Merge táº¥t cáº£ shard thÃ nh 1 HTML report duy nháº¥t
  merge-report:
    if: always()
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      # ğŸ‘‰ Download toÃ n bá»™ blob report tá»« cÃ¡c shard
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports

      # ğŸ‘‰ Merge thÃ nh HTML duy nháº¥t
      - name: Merge reports thÃ nh HTML duy nháº¥t
        run: |
          npx playwright merge-reports \
            --reporter html \
            ./all-blob-reports

      # ğŸ‘‰ Upload HTML report (Ä‘á»ƒ download thá»§ cÃ´ng náº¿u cáº§n)
      - name: Upload final HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ vars.ENV }}
          path: playwright-report
          retention-days: 30

  # ğŸ‘‰ Deploy report lÃªn GitHub Pages (chá»‰ main)
  deploy-report:
    needs: merge-report
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download final report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ vars.ENV }}
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
