name: Playwright Tests

on:
  push:
    branches: [main, develop]

  merge_group:
    branches: [main, develop]

  # re-register cron
  workflow_dispatch:

  # üëâ Cron ch·∫°y m·ªói ng√†y
  schedule:
    - cron: "0 1 * * *"

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # üëâ Cron lu√¥n d√πng staging (tr√°nh b·ªã hi·ªÉu nh·∫ßm l√† main)
    # ‚úÖ FIX: d√πng github.ref thay v√¨ github.ref_name
    # ‚úÖ FIX: vi·∫øt 1 d√≤ng ƒë·ªÉ tr√°nh l·ªói YAML
    # ‚úÖ FIX (NEW): d√πng startsWith ƒë·ªÉ support merge_group (merge queue t·∫°o ref ƒë·∫∑c bi·ªát)
    environment: ${{ github.event_name == 'schedule' && 'staging' || startsWith(github.ref, 'refs/heads/main') && 'production' || startsWith(github.ref, 'refs/heads/develop') && 'staging' }}

    # üëâ Chia test th√†nh 4 shard ƒë·ªÉ ch·∫°y song song
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    env:
      # ‚ö†Ô∏è Bi·∫øn n√†y l·∫•y t·ª´ GitHub Environment (staging / production)
      # üëâ Ch·ªâ ƒë√∫ng khi environment ph√≠a tr√™n resolve ƒë√∫ng
      ENV: ${{ vars.ENV }}

      # ‚úÖ NEW: Base URL cho Playwright (production/staging t√πy environment)
      BASE_URL: ${{ vars.BASE_URL }}

      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      # üëâ Cron checkout develop
      # ‚ö†Ô∏è L∆∞u √Ω: github.ref_name c·ªßa cron v·∫´n l√† main
      # ‚Üí n√™n ph·∫£i √©p checkout develop ƒë·ªÉ test ƒë√∫ng staging
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # üëâ Ch·∫°y test theo shard + t·∫°o blob report ƒë·ªÉ merge sau
      - name: Run Playwright tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }}/4 \
            --reporter=blob \
            --retries=1

      # üëâ Upload blob report t·∫°m th·ªùi (d√πng ƒë·ªÉ merge)
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1


  # üëâ Merge t·∫•t c·∫£ shard th√†nh 1 HTML report duy nh·∫•t
  merge-report:
    if: always()
    needs: test
    runs-on: ubuntu-latest

    # ‚úÖ EXPORT SUMMARY SAU MERGE (matrix kh√¥ng export ƒë∆∞·ª£c)
    outputs:
      passed: ${{ steps.summary.outputs.passed }}
      failed: ${{ steps.summary.outputs.failed }}
      skipped: ${{ steps.summary.outputs.skipped }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      # üëâ Download to√†n b·ªô blob report t·ª´ c√°c shard
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports

      # üëâ FIX: Flatten t·∫•t c·∫£ file blob report v√†o 1 folder chung
      # ‚ö†Ô∏è Playwright merge-reports y√™u c·∫ßu t·∫•t c·∫£ blob ·ªü c√πng 1 folder
      - name: Prepare blob reports
        run: |
          mkdir merged-blobs
          find all-blob-reports -type f -exec cp {} merged-blobs/ \;

      # üëâ Merge th√†nh HTML duy nh·∫•t
      - name: Merge reports th√†nh HTML duy nh·∫•t
        run: |
          npx playwright merge-reports \
          --reporter html,json \
          ./merged-blobs

      # ‚úÖ NEW (B·∫ÆT BU·ªòC): Upload report ƒë√£ merge ƒë·ªÉ job deploy d√πng
      # ‚ö†Ô∏è N·∫øu kh√¥ng c√≥ b∆∞·ªõc n√†y th√¨ deploy-report s·∫Ω FAIL v√¨ kh√¥ng t√¨m th·∫•y artifact
      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7

      # ‚úÖ Extract summary t·ª´ report ƒë√£ merge (FULL DATA)
      - name: Extract final summary
        id: summary
        run: |
          if [ -f playwright-report/test-results.json ]; then
            PASSED=$(jq '[.. | objects | select(.status? == "passed")] | length' playwright-report/test-results.json)
            FAILED=$(jq '[.. | objects | select(.status? == "failed")] | length' playwright-report/test-results.json)
            SKIPPED=$(jq '[.. | objects | select(.status? == "skipped")] | length' playwright-report/test-results.json)
          else
            PASSED=0
            FAILED=0
            SKIPPED=0
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT


  # üëâ Deploy report l√™n GitHub Pages (ch·ªâ main)
  deploy-report:
    needs: merge-report

    # ‚úÖ FIX (NEW): kh√¥ng deploy khi l√† cron
    # üëâ Cron ch·ªâ d√πng ƒë·ªÉ test staging
    if: github.ref == 'refs/heads/main' && github.event_name != 'schedule'

    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download final report
        uses: actions/download-artifact@v4
        with:
          # ‚ö†Ô∏è Ph·∫£i tr√πng ƒë√∫ng t√™n artifact ƒë√£ upload ·ªü job merge-report
          name: playwright-report
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4


  notify-slack:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true
    environment: slack

    steps:
    - name: Send Slack notification
      run: |
        RESULT="${{ needs.merge-report.result }}"

        if [ "$RESULT" = "success" ]; then
          STATUS="PASSED"
          COLOR="#36a64f"
          ICON="‚úÖ"
        else
          STATUS="FAILED"
          COLOR="#ff0000"
          ICON="‚ùå"
        fi

        PASSED="${{ needs.merge-report.outputs.passed }}"
        FAILED="${{ needs.merge-report.outputs.failed }}"
        SKIPPED="${{ needs.merge-report.outputs.skipped }}"

        # ‚ö†Ô∏è FIX nh·ªè: cron checkout develop nh∆∞ng github.ref_name v·∫´n l√† main
        BRANCH="${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}"

        ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        WEBHOOK="${{ secrets.SLACK_WEBHOOK_URL }}"

        curl -X POST \
          -H "Content-type: application/json" \
          --data "{
            \"attachments\": [
              {
                \"color\": \"$COLOR\",
                \"title\": \"$ICON Playwright CI $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"$BRANCH\", \"short\": true},
                  {\"title\": \"Passed\", \"value\": \"$PASSED\", \"short\": true},
                  {\"title\": \"Failed\", \"value\": \"$FAILED\", \"short\": true},
                  {\"title\": \"Skipped\", \"value\": \"$SKIPPED\", \"short\": true},
                  {\"title\": \"Actions\", \"value\": \"$ACTION_URL\", \"short\": false},
                  {\"title\": \"Report\", \"value\": \"$REPORT_URL\", \"short\": false}
                ]
              }
            ]
          }" \
          "$WEBHOOK"


  notify-telegram:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true

    steps:
      - name: Send Telegram notification
        run: |
          RESULT="${{ needs.merge-report.result }}"

          if [ "$RESULT" = "success" ]; then
            STATUS="PASSED"
            ICON="‚úÖ"
          else
            STATUS="FAILED"
            ICON="‚ùå"
          fi

          PASSED="${{ needs.merge-report.outputs.passed }}"
          FAILED="${{ needs.merge-report.outputs.failed }}"
          SKIPPED="${{ needs.merge-report.outputs.skipped }}"

          # ‚ö†Ô∏è FIX nh·ªè gi·ªëng Slack
          BRANCH="${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}"

          ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          MESSAGE=$(cat <<EOF
          üé≠ Playwright CI $STATUS $ICON

          Repository: ${{ github.repository }}
          Branch: $BRANCH

          üìä Test Summary
          ‚Ä¢ Passed: $PASSED
          ‚Ä¢ Failed: $FAILED
          ‚Ä¢ Skipped: $SKIPPED

          üîó Actions: $ACTION_URL
          üìà Report: $REPORT_URL
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode text="$MESSAGE"
