name: Playwright Tests

on:
  # -------------------------------------------------
  # Ch·∫°y khi push l√™n 2 branch ch√≠nh
  # -------------------------------------------------
  push:
    branches: [main, develop]

  # -------------------------------------------------
  # H·ªó tr·ª£ merge queue (merge_group event)
  # -------------------------------------------------
  merge_group:
    branches: [main, develop]

  # -------------------------------------------------
  # Cho ph√©p ch·∫°y tay
  # -------------------------------------------------
  workflow_dispatch:

  # -------------------------------------------------
  # Cron ch·∫°y m·ªói ng√†y l√∫c 01:00 UTC
  # -------------------------------------------------
  schedule:
    - cron: "0 1 * * *"

jobs:
  test:
    # -------------------------------------------------
    # Gi·ªõi h·∫°n t·ªëi ƒëa 60 ph√∫t cho to√†n b·ªô job test
    # -------------------------------------------------
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # -------------------------------------------------
    # Resolve GitHub Environment cho job
    #
    # Quy ∆∞·ªõc:
    # - main    -> staging
    # - develop -> develop
    # - cron    -> staging
    #
    # L√Ω do d√πng github.ref + startsWith:
    # - merge_group t·∫°o ref ƒë·∫∑c bi·ªát
    # - tr√°nh sai khi d√πng github.ref_name
    # -------------------------------------------------
    environment: ${{ github.event_name == 'schedule' && 'staging' || github.event_name == 'merge_group' && github.event.merge_group.base_ref == 'main' && 'staging' || github.event_name == 'merge_group' && github.event.merge_group.base_ref == 'develop' && 'develop' || startsWith(github.ref, 'refs/heads/main') && 'staging' || startsWith(github.ref, 'refs/heads/develop') && 'develop' }}

    # -------------------------------------------------
    # Ch·∫°y song song 4 shard
    # -------------------------------------------------
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    env:
      # -------------------------------------------------
      # vars.* l·∫•y t·ª´ GitHub Environment ƒë√£ resolve ·ªü tr√™n
      # (staging ho·∫∑c develop)
      # -------------------------------------------------
      ENV: ${{ vars.ENV }}
      BASE_URL: ${{ vars.BASE_URL }}

      # -------------------------------------------------
      # secrets d√πng chung cho c·∫£ 2 environment
      # -------------------------------------------------
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      # -------------------------------------------------
      # Checkout ƒë√∫ng branch ƒëang trigger workflow
      # (cron v·∫´n checkout main)
      # -------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref_name }}

      # -------------------------------------------------
      # C√†i NodeJS (LTS) + cache npm
      # -------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: npm

      # -------------------------------------------------
      # C√†i dependency theo package-lock.json
      # -------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -------------------------------------------------
      # C√†i browser cho Playwright
      # -------------------------------------------------
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # -------------------------------------------------
      # Ch·∫°y test theo t·ª´ng shard
      # --reporter=blob ƒë·ªÉ t·∫°o report trung gian
      # d√πng cho b∆∞·ªõc merge ph√≠a sau
      # -------------------------------------------------
      - name: Run Playwright tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }}/4 \
            --reporter=blob \
            --retries=1

      # -------------------------------------------------
      # Upload blob report c·ªßa t·ª´ng shard
      # -------------------------------------------------
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1


  # -------------------------------------------------
  # Job merge report t·ª´ t·∫•t c·∫£ shard
  # -------------------------------------------------
  merge-report:
    if: always()
    needs: test
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repo ƒë·ªÉ d√πng playwright CLI
      # -------------------------------------------------
      - uses: actions/checkout@v5

      # -------------------------------------------------
      # C√†i NodeJS
      # -------------------------------------------------
      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      # -------------------------------------------------
      # C√†i dependency ƒë·ªÉ c√≥ playwright CLI
      # -------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -------------------------------------------------
      # Download to√†n b·ªô blob report t·ª´ c√°c shard
      # -------------------------------------------------
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports

      # -------------------------------------------------
      # Gom to√†n b·ªô file blob v√†o 1 folder
      # v√¨ playwright merge-reports y√™u c·∫ßu
      # t·∫•t c·∫£ blob n·∫±m chung 1 th∆∞ m·ª•c
      # -------------------------------------------------
      - name: Prepare blob reports
        run: |
          mkdir merged-blobs
          find all-blob-reports -type f -exec cp {} merged-blobs/ \;

      # -------------------------------------------------
      # Merge blob report th√†nh report HTML + JSON
      # -------------------------------------------------
      - name: Merge reports
        run: |
          npx playwright merge-reports \
            --reporter html,json \
            ./merged-blobs

      # -------------------------------------------------
      # Upload report ƒë√£ merge
      # d√πng cho job deploy-report ph√≠a sau
      # -------------------------------------------------
      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7


  # -------------------------------------------------
  # Deploy report l√™n GitHub Pages
  #
  # Ch·∫°y khi:
  # - branch l√† main ho·∫∑c develop
  # - cron c≈©ng ƒë∆∞·ª£c deploy
  #
  # L∆∞u √Ω:
  # - report c·ªßa main / develop / cron d√πng chung 1 site
  # - ch·∫°y sau s·∫Ω ƒë·∫°p report c·ªßa l·∫ßn ch·∫°y tr∆∞·ªõc
  # -------------------------------------------------
  deploy-report:
    needs: merge-report
    if: always() && github.event_name != 'merge_group'
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      # -------------------------------------------------
      # Download report ƒë√£ merge
      # -------------------------------------------------
      - name: Download final report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./public

      # -------------------------------------------------
      # Upload artifact cho GitHub Pages
      # -------------------------------------------------
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      # -------------------------------------------------
      # Deploy l√™n GitHub Pages
      # -------------------------------------------------
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4


  # -------------------------------------------------
  # G·ª≠i th√¥ng b√°o Slack
  # -------------------------------------------------
  notify-slack:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true
    environment: slack

    steps:
      - name: Send Slack notification
        shell: bash
        run: |
          set -e

          RESULT="${{ needs.test.result }}"

          if [ "$RESULT" = "success" ]; then
            STATUS="PASSED"
            COLOR="#36a64f"
            ICON="‚úÖ"
          else
            STATUS="FAILED"
            COLOR="#ff0000"
            ICON="‚ùå"
          fi

          BRANCH="${{ github.event_name == 'merge_group' && github.event.merge_group.base_ref || github.ref_name }}"

          ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          curl -s -X POST \
            -H "Content-type: application/json" \
            --data @- \
            "${{ secrets.SLACK_WEBHOOK_URL }}" <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "Playwright CI $STATUS $ICON",
                "fields": [
                  { "title": "Repository", "value": "${{ github.repository }}", "short": true },
                  { "title": "Branch", "value": "$BRANCH", "short": true },
                  { "title": "Actions", "value": "$ACTION_URL", "short": false },
                  { "title": "Report", "value": "$REPORT_URL", "short": false }
                ]
              }
            ]
          }
          EOF


  # -------------------------------------------------
  # G·ª≠i th√¥ng b√°o Telegram
  # -------------------------------------------------
  notify-telegram:
    needs: [merge-report, deploy-report]
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true

    steps:
      - name: Send Telegram notification
        run: |
          RESULT="${{ needs.test.result }}"

          if [ "$RESULT" = "success" ]; then
            STATUS="PASSED"
            ICON="‚úÖ"
          else
            STATUS="FAILED"
            ICON="‚ùå"
          fi

          BRANCH="${{ github.event_name == 'merge_group' && github.event.merge_group.base_ref || github.ref_name }}"

          ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          MESSAGE=$(printf "<b>üé≠ Playwright CI %s %s</b>\n\nRepository: %s\nBranch: %s\n\nüîó Actions: %s\nüìà Report: %s" \
            "$STATUS" \
            "$ICON" \
            "${{ github.repository }}" \
            "$BRANCH" \
            "$ACTION_URL" \
            "$REPORT_URL")

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            --data-urlencode text="$MESSAGE"
