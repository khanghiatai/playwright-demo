name: Playwright Tests

on:
  push:
    branches: [main, develop]

  merge_group:
    branches: [main, develop]

  # re-register cron
  workflow_dispatch:

  # üëâ Cron ch·∫°y m·ªói ng√†y
  schedule:
    - cron: "0 1 * * *"

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # üëâ Cron lu√¥n d√πng staging (tr√°nh b·ªã hi·ªÉu nh·∫ßm l√† main)
    # ‚úÖ FIX: d√πng github.ref thay v√¨ github.ref_name
    # ‚úÖ FIX: vi·∫øt 1 d√≤ng ƒë·ªÉ tr√°nh l·ªói YAML
    environment: ${{ github.event_name == 'schedule' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/develop' && 'staging' }}

    # üëâ Chia test th√†nh 4 shard ƒë·ªÉ ch·∫°y song song
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    env:
      ENV: ${{ vars.ENV }}
      BASE_URL: ${{ vars.BASE_URL }} # ‚úÖ NEW: Base URL cho Playwright (production/staging t√πy environment)
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      # üëâ Cron checkout develop
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'schedule' && 'develop' || github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # üëâ Ch·∫°y test theo shard + t·∫°o blob report ƒë·ªÉ merge sau
      - name: Run Playwright tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            --shard=${{ matrix.shard }}/4 \
            --reporter=blob \
            --retries=1

      # üëâ Upload blob report t·∫°m th·ªùi (d√πng ƒë·ªÉ merge)
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: blob-report
          retention-days: 1

      # ‚ùå REMOVE outputs block (g√¢y fail CI)
      # üëâ Extract summary ch·ªâ ƒë·ªÉ d√πng trong job n√†y (kh√¥ng export outputs)
      - name: Extract Playwright summary
        id: summary
        if: always()
        run: |
          if [ -f playwright-report/data/test-results.json ]; then
            PASSED=$(jq '[.suites[].specs[].tests[] | select(.status=="passed")] | length' playwright-report/data/test-results.json)
            FAILED=$(jq '[.suites[].specs[].tests[] | select(.status=="failed")] | length' playwright-report/data/test-results.json)
            SKIPPED=$(jq '[.suites[].specs[].tests[] | select(.status=="skipped")] | length' playwright-report/data/test-results.json)
          else
            PASSED=0
            FAILED=0
            SKIPPED=0
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT


  # üëâ Merge t·∫•t c·∫£ shard th√†nh 1 HTML report duy nh·∫•t
  merge-report:
    if: always()
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      # üëâ Download to√†n b·ªô blob report t·ª´ c√°c shard
      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports

      # üëâ FIX: Flatten t·∫•t c·∫£ file blob report v√†o 1 folder chung
      - name: Prepare blob reports
        run: |
          mkdir merged-blobs
          find all-blob-reports -type f -exec cp {} merged-blobs/ \;

      # üëâ Merge th√†nh HTML duy nh·∫•t
      - name: Merge reports th√†nh HTML duy nh·∫•t
        run: |
          npx playwright merge-reports \
            --reporter html \
            ./merged-blobs

      # üëâ Upload HTML report (ƒë·ªÉ download th·ªß c√¥ng n·∫øu c·∫ßn)
      - name: Upload final HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ vars.ENV }}
          path: playwright-report
          retention-days: 30


  # üëâ Deploy report l√™n GitHub Pages (ch·ªâ main)
  deploy-report:
    needs: merge-report
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download final report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ vars.ENV }}
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  notify-slack:
    needs: deploy-report
    runs-on: ubuntu-latest
    if: always()
    environment: slack

    steps:
    - name: Send Slack notification
      run: |
        RESULT="${{ job.status }}"

        if [ "$RESULT" = "success" ]; then
          STATUS="PASSED"
          COLOR="#36a64f"
          ICON="‚úÖ"
        else
          STATUS="FAILED"
          COLOR="#ff0000"
          ICON="‚ùå"
        fi

        ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        WEBHOOK="${{ secrets.SLACK_WEBHOOK_URL }}"

        curl -X POST \
          -H "Content-type: application/json" \
          --data "{
            \"attachments\": [
              {
                \"color\": \"$COLOR\",
                \"title\": \"$ICON Playwright CI $STATUS\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Actions\", \"value\": \"$ACTION_URL\", \"short\": false},
                  {\"title\": \"Report\", \"value\": \"$REPORT_URL\", \"short\": false}
                ]
              }
            ]
          }" \
          "$WEBHOOK"

  notify-telegram:
  needs: [test, deploy-report]
  runs-on: ubuntu-latest
  if: always()
  continue-on-error: true

  steps:
    - name: Send Telegram notification
      run: |
        RESULT="${{ needs.test.result }}"

        if [ "$RESULT" = "success" ]; then
          STATUS="PASSED"
          ICON="‚úÖ"
        else
          STATUS="FAILED"
          ICON="‚ùå"
        fi

        ACTION_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

        PASSED="${{ needs.test.outputs.passed }}"
        FAILED="${{ needs.test.outputs.failed }}"
        SKIPPED="${{ needs.test.outputs.skipped }}"

        MESSAGE=$(cat <<EOF
üé≠ Playwright CI $STATUS $ICON

Repository: ${{ github.repository }}
Branch: ${{ github.ref_name }}

üìä Test Summary
‚Ä¢ Passed: $PASSED
‚Ä¢ Failed: $FAILED
‚Ä¢ Skipped: $SKIPPED

üîó Actions: $ACTION_URL
üìà Report: $REPORT_URL
EOF
)

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          --data-urlencode text="$MESSAGE"

            